var page,physics,moveTypes,animation=function(){var e,t,n,s,o,i,a,r,l,d,u,h;function g(){a=0,o=moveTypes.none,s=moveTypes.none,u=!1,e=new Sprite(10,200,50,78),c(),setTimeout(m,1e3/30)}function p(e,t){switch(e){case"x":o=t;break;case"y":s=t;break}}function c(){(!i||!t)&&(i=$("#canvas")[0],t=i.getContext("2d")),i.width=i.width;var s,o=n.width-300,a=0;e.x>300&&e.x<=o?(s=(e.x-300)*-1,a=e.x-300):e.x>o?(s=(o-300)*-1,a=n.width-600):s=0,t.translate(s,0),t.save(),e.moveXStatus==moveTypes.left&&(t.translate(e.x*2+e.width,0),t.scale(-1,1)),t.drawImage(images[1],e.x,e.y),t.restore(),t.fillStyle=n.color,t.fillRect(n.x,n.y,n.width,n.height),v(a)}function v(e){for(var n,s=0;s<blocks.length;s++)n=blocks[s],n.x<e+600&&n.x+n.width>e&&(n.url?t.drawImage(images[0],n.x,n.y):(t.fillStyle=n.color,t.fillRect(n.x,n.y,n.width,n.height)))}function m(){e.moveXStatus=o,e.moveXStatus=o,s!=moveTypes.none&&e.moveYStatus==moveTypes.none&&(e.moveYStatus=s,e.airTime=0,s=moveTypes.none),e.update(),(o!=moveTypes.none||s!=moveTypes.none||e.moveYStatus!=moveTypes.none)&&c(),e.x+e.width>=n.width-10&&(u=!0,f()),b(),j(),u||(h=setTimeout(m,1e3/30))}function b(){var e=a;d||(d=$("#clock")[0]),e=e+1e3/30,a=e,d.innerText=(e/1e3).toFixed()}function j(){(!l||!r)&&(l=$("#x-coord")[0],r=$("#y-coord")[0]),l.innerText=e.x,r.innerText=e.y.toFixed(2)}function f(){console.log("win"),clearTimeout(h),page.changeLevel(a)}function y(e){n=e}function _(){return n}return{beginClock:g,draw:c,ground:_,move:p,setGround:y,win:f}}();const level2={levelNum:2,blocks:[{__comment:"Square block",x:320,y:200,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Square block",x:200,y:120,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Thin platform",x:340,y:40,width:125,height:5,color:"rgba(170,69,19,1)"},{__comment:"Tall rectangular block",x:540,y:80,width:30,height:180,color:"rgba(0,0,0,1)"},{__comment:"Square block",x:600,y:200,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Square block",x:700,y:200,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Square block",x:780,y:150,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Square block",x:830,y:100,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Thin platform",x:920,y:80,width:200,height:5,color:"rgba(170,69,19,1)"},{__comment:"Square block",x:1220,y:90,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{__comment:"Tall rectangular block",x:1370,y:120,width:30,height:150,color:"rgba(0,0,0,1)"}],ground:{x:0,y:280,width:1500,height:20,color:"rgba(100,100,100,1)"},background:"url(/images/bg_ruins_ship_2_3.jpg)"},level1={levelNum:1,blocks:[{x:320,y:160,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{x:380,y:120,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{x:500,y:80,width:150,height:5,color:"rgba(170,69,19,1)"},{x:725,y:40,width:125,height:5,color:"rgba(170,69,19,1)"},{x:980,y:80,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{x:1100,y:80,width:30,height:30,color:"rgba(0,0,0,1)",url:"images/blocks.jpg"},{x:1230,y:100,width:100,height:5,color:"rgba(170,69,19,1)"},{x:1370,y:120,width:30,height:150,color:"rgba(0,0,0,1)"}],ground:{x:0,y:280,width:1500,height:20,color:"rgba(100,100,100,1)"},background:"url(/images/bg_river_1_3.jpg)"},levels={level1,level2};let images=[];window.onload=function(){var e=["/images/block.png","/images/vK_50x78.png"];console.log("start game load"),$.when($.Deferred(function(t){var n=new Image;n.onload=function(){images[0]=n,t.resolve()},n.src=e[0]}),$.Deferred(function(t){var n=new Image;n.onload=function(){images[1]=n,t.resolve()},n.src=e[1]}),$.Deferred(function(e){$(e.resolve)})).done(function(){var t,e=$("#message")[0];e.innerHTML="Loading complete!<br/><br/>",t=function(e){page.startGame(e.id)},e.setAttribute("touchstart",function(){}),console.log(typeof e.ontouchstart),$(e).append("<button id='start' class='button primary'>Start Game</button>"),$("#start").click(function(e){t(e.target)})})},page=function(){var e,n,o,u,r=["load-screen","game-screen","level-complete"];function a(){i()}function h(t){o=$("#left")[0],n=$("#right"),u=$("#jump"),t=="touch"?m():f(),e=0,i()}function t(e){for(var t=0;t<r.length;t++)$("#"+r[t]).addClass("hidden");$("#"+e).toggleClass("hidden")}function i(){e++;const s="level"+e;let n=levels[s];animation.setGround(n.ground),physics.setBlocks(n.blocks),t("game-screen"),$("#game-display").css("background-image",n.background),animation.beginClock()}function m(){var e,t;typeof TouchEvent=="object"?(e="touchstart",t="touchend"):(e="mousedown",t="mouseup"),o.addEventListener(e,function(e){e.preventDefault(),l()}),o.addEventListener(t,function(e){e.preventDefault(),s()}),n.addEventListener(e,function(e){e.preventDefault(),c()}),n.addEventListener(t,function(e){e.preventDefault(),s()}),u.addEventListener(e,function(e){e.preventDefault(),d()}),$("#keys").addClass("hidden")}function f(){addEventListener("keydown",function(e){e.preventDefault();var t=e.keyCode;switch(t){case 37:l();break;case 39:c();break;case 32:case 38:d();break}}),addEventListener("keyup",function(e){e.preventDefault();var t=e.keyCode;switch(t){case 37:case 39:s();break}}),$("#buttons").addClass("hidden")}function p(n){var s=$("#nextlevel")[0],o=$("#time")[0];s.removeEventListener("click",a),o.innerText="Finish time: "+(n/1e3).toFixed()+" seconds",e==2?(s.disabled=!0,s.style.display="none",o.innerHTML+="<br/>Game over! You win!"):s.addEventListener("click",a),t("level-complete")}function c(){try{animation.move("x",moveTypes.right)}catch(e){console.log(e)}}function l(){try{animation.move("x",moveTypes.left)}catch(e){console.log(e)}}function d(){try{animation.move("y",moveTypes.jumping)}catch(e){console.log(e)}}function s(){try{animation.move("x",moveTypes.none)}catch(e){console.log(e)}}return{changeLevel:p,levelCount:e,startGame:h,toggleDisplay:t}}(),physics={blocks:0[0],adjustMove:function(e,t,n,s,o,i,a,r){var u={},f=e+o,p=t+i,c=o,h=i,m=null,g=animation.ground().width,l=this.testHit(e,p,n,s,{startY:t,moveDir:a}),d=this.testHit(f,t,n,s);return a==moveTypes.right?f>g-n?c=g-n-e:d&&(c=d.x-(e+n)):a==moveTypes.left&&(f<0?c=0-e:d&&(c=d.x+d.width-e)),r==moveTypes.jumping&&l&&(h=l.y+l.height-t,m=moveTypes.falling),i>0&&(p>280-s?(h=280-s-t,m=moveTypes.none):l&&(h=l.y-(t+s),m=moveTypes.none)),u.x=c,u.y=h,u.moveYStatus=m,u},testHit:function(e,t,n,s,o){for(var i,a,r,l,d,u,h,c=0;c<blocks.length;c++){if(i=blocks[c],a=e+n>i.x,r=e<i.x+i.width,l=t+s>i.y,d=t<i.y+i.height,a&&r&&l&&d)return i;if(o!=null&&(o.moveDir==moveTypes.falling&&(u=o.startY<=i.y+5,h=t+s+5>=i.y),a&&r&&u&&h))return i}return null},testFall:function(e,t){var n=!1;return this.testHit(e,t+1)||(n=!0),n},jump:function(e){var t={},n=e*2-4,s=moveTypes.jumping,o=e;return n>-.5?(s=moveTypes.falling,o=0):n=n*10,t.y=n,t.status=s,t.time=o,t},fall:function(e){var t={},n=e**2*10,s=moveTypes.falling,o=e;return t.y=n,t.status=s,t.time=o,t},setBlocks:function(e){blocks=e}},moveTypes={none:"none",right:"right",left:"left",jumping:"jumping",falling:"falling"};function Sprite(e,t,n,s){this.x=e,this.y=t,this.width=n,this.height=s,this.color="rgba(0,0,0,1)",this.airTime=0,this.moveXStatus=moveTypes.none,this.moveYStatus=moveTypes.none,this.move=10}Sprite.prototype.update=function(){var t,o,n=0,s=0,e=null;switch(this.moveXStatus){case moveTypes.right:n=this.move;break;case moveTypes.left:n=0-this.move;break}switch(this.moveYStatus){case moveTypes.jumping:e=physics.jump(this.airTime);break;case moveTypes.falling:e=physics.fall(this.airTime);break;default:o=physics.testFall(this.x,this.y),o&&(this.moveYStatus=moveTypes.falling)}e&&(this.airTime=e.time+1/3,this.moveYStatus=e.status,s=e.y),t=physics.adjustMove(this.x,this.y,this.width,this.height,n,s,this.moveXStatus,this.moveYStatus),t.moveYStatus&&(this.moveYStatus=t.moveYStatus,this.airTime=0),this.x=this.x+t.x,this.y=this.y+t.y}