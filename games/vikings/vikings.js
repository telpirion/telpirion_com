var animation=function(){var a,r,t,n,o,i,l,s,c,u,m,v;function h(){a&&r||(a=$("#canvas")[0],r=a.getContext("2d")),a.width=a.width;for(var e,t,n=v.width-300,o=0,i=(300<l.x&&l.x<=n?(e=-1*(l.x-300),o=l.x-300):l.x>n?(e=-1*(n-300),o=v.width-600):e=0,r.translate(e,0),r.save(),l.moveXStatus==moveTypes.left&&(r.translate(2*l.x+l.width,0),r.scale(-1,1)),r.drawImage(images[1],l.x,l.y),r.restore(),r.fillStyle=v.color,r.fillRect(v.x,v.y,v.width,v.height),o),s=0;s<blocks.length;s++)(t=blocks[s]).x<i+600&&t.x+t.width>i&&(t.url?r.drawImage(images[0],t.x,t.y):(r.fillStyle=t.color,r.fillRect(t.x,t.y,t.width,t.height)))}function d(){l.moveXStatus=s,l.moveXStatus=s,c!=moveTypes.none&&l.moveYStatus==moveTypes.none&&(l.moveYStatus=c,l.airTime=0,c=moveTypes.none),l.update(),s==moveTypes.none&&c==moveTypes.none&&l.moveYStatus==moveTypes.none||h(),l.x+l.width>=v.width-10&&(i=!0,p());var e=n;o=o||$("#clock")[0],n=e+=1e3/30,o.innerText=(e/1e3).toFixed(),u&&m||(u=$("#x-coord")[0],m=$("#y-coord")[0]),u.innerText=l.x,m.innerText=l.y.toFixed(2),i||(t=setTimeout(d,1e3/30))}function p(){console.log("win"),clearTimeout(t),page.changeLevel(n)}return{beginClock:function(){n=0,s=moveTypes.none,c=moveTypes.none,i=!1,l=new Sprite(10,200,50,78),h(),setTimeout(d,1e3/30)},draw:h,ground:function(){return v},move:function(e,t){switch(e){case"x":s=t;break;case"y":c=t}},setGround:function(e){v=e},win:p}}(),physics={blocks:void 0,adjustMove:function(e,t,n,o,i,s,a,r){var l={},c=e+i,u=t+s,m=s,v=null,h=animation.ground().width,d=this.testHit(e,u,n,o,{startY:t,moveDir:a}),p=this.testHit(c,t,n,o);return a==moveTypes.right?h-n<c?i=h-n-e:p&&(i=p.x-(e+n)):a==moveTypes.left&&(c<0?i=0-e:p&&(i=p.x+p.width-e)),r==moveTypes.jumping&&d&&(m=d.y+d.height-t,v=moveTypes.falling),0<s&&(280-o<u?(m=280-o-t,v=moveTypes.none):d&&(m=d.y-(t+o),v=moveTypes.none)),l.x=i,l.y=m,l.moveYStatus=v,l},testHit:function(e,t,n,o,i){for(var s,a,r,l,c,u,m,v=0;v<blocks.length;v++){if(a=e+n>(s=blocks[v]).x,r=e<s.x+s.width,l=t+o>s.y,c=t<s.y+s.height,a&&r&&l&&c)return s;if(null!=i&&(i.moveDir==moveTypes.falling&&(u=i.startY<=s.y+5,m=t+o+5>=s.y),a)&&r&&u&&m)return s}return null},testFall:function(e,t){var n=!1;return n=this.testHit(e,t+1)?n:!0},jump:function(e){var t={},n=2*e-4,o=moveTypes.jumping;return-.5<n?(o=moveTypes.falling,e=0):n*=10,t.y=n,t.status=o,t.time=e,t},fall:function(e){var t={},n=10*Math.pow(e,2),o=moveTypes.falling;return t.y=n,t.status=o,t.time=e,t},setBlocks:function(e){blocks=e}},moveTypes={none:"none",right:"right",left:"left",jumping:"jumping",falling:"falling"};function Sprite(e,t,n,o){this.x=e,this.y=t,this.width=n,this.height=o,this.color="rgba(0,0,0,1)",this.airTime=0,this.moveXStatus=moveTypes.none,this.moveYStatus=moveTypes.none,this.move=10}Sprite.prototype.update=function(){var e=0,t=0,n=null;switch(this.moveXStatus){case moveTypes.right:e=this.move;break;case moveTypes.left:e=0-this.move}switch(this.moveYStatus){case moveTypes.jumping:n=physics.jump(this.airTime);break;case moveTypes.falling:n=physics.fall(this.airTime);break;default:physics.testFall(this.x,this.y)&&(this.moveYStatus=moveTypes.falling)}n&&(this.airTime=n.time+1/3,this.moveYStatus=n.status,t=n.y);t=physics.adjustMove(this.x,this.y,this.width,this.height,e,t,this.moveXStatus,this.moveYStatus);t.moveYStatus&&(this.moveYStatus=t.moveYStatus,this.airTime=0),this.x=this.x+t.x,this.y=this.y+t.y};var page=function(){var n,o,i,s,a=["load-screen","game-screen","level-complete"];function r(){c()}function l(e){for(var t=0;t<a.length;t++)$("#"+a[t]).addClass("hidden");$("#"+e).toggleClass("hidden")}function c(){var t="level"+ ++s+".json",n=new XMLHttpRequest;n.addEventListener("load",function(){console.log(t+" load complete.");var e=n.response;animation.setGround(e.ground),physics.setBlocks(e.blocks),l("game-screen"),$("#game-display").css("background-image",e.background),animation.beginClock()}),n.responseType="json",n.open("GET",t),n.send()}function u(){try{animation.move("x",moveTypes.right)}catch(e){console.log(e)}}function m(){try{animation.move("x",moveTypes.left)}catch(e){console.log(e)}}function v(){try{animation.move("y",moveTypes.jumping)}catch(e){console.log(e)}}function h(){try{animation.move("x",moveTypes.none)}catch(e){console.log(e)}}return{changeLevel:function(e){var t=$("#nextlevel")[0],n=$("#time")[0];t.removeEventListener("click",r),n.innerText="Finish time: "+(e/1e3).toFixed()+" seconds",2==s?(t.disabled=!0,t.style.display="none",n.innerHTML+="<br/>Game over! You win!"):t.addEventListener("click",r),l("level-complete")},levelCount:s,startGame:function(e){var t;n=$("#left")[0],o=$("#right"),i=$("#jump"),("touch"==e?(e="object"==typeof TouchEvent?(t="touchstart","touchend"):(t="mousedown","mouseup"),n.addEventListener(t,function(e){e.preventDefault(),m()}),n.addEventListener(e,function(e){e.preventDefault(),h()}),o.addEventListener(t,function(e){e.preventDefault(),u()}),o.addEventListener(e,function(e){e.preventDefault(),h()}),i.addEventListener(t,function(e){e.preventDefault(),v()}),$("#keys")):(addEventListener("keydown",function(e){switch(e.preventDefault(),e.keyCode){case 37:m();break;case 39:u();break;case 32:case 38:v()}}),addEventListener("keyup",function(e){switch(e.preventDefault(),e.keyCode){case 37:case 39:h()}}),$("#buttons"))).addClass("hidden"),s=0,c()},toggleDisplay:l}}(),images=[];window.onload=function(){var n=["/images/block.png","/images/vK_50x78.png"];console.log("start game load"),$.when($.Deferred(function(e){var t=new Image;t.onload=function(){images[0]=t,e.resolve()},t.src=n[0]}),$.Deferred(function(e){var t=new Image;t.onload=function(){images[1]=t,e.resolve()},t.src=n[1]}),$.Deferred(function(e){$(e.resolve)})).done(function(){var e=$("#message")[0];e.innerHTML="Loading complete!<br/><br/>";e.setAttribute("touchstart",function(){}),console.log(typeof e.ontouchstart),$(e).append("<input id='start' type='button' value='Start game' />"),$("#start").click(function(e){e=e.target,page.startGame(e.id)})})};